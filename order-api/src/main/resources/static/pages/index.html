<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>粤K万丰石材</title>
    <link rel="stylesheet" media="all" href="layui/css/layui.css">
</head>
<body>
<script src="layui/layui.all.js"></script>

<script src="layui/layui.js"></script>

<div class="layui-tab" id="project-form" style="display:none">
    <ul class="layui-tab-title">
        <li class="layui-this">基本信息</li>
        <li>项目明细</li>
        <li>收费明细</li>
    </ul>
    <div class="layui-tab-content">
        <div class="layui-tab-item layui-show">

            <form class="layui-form">
                <div class="layui-form-item">
                    <div class="layui-inline">
                        <label class="layui-form-label">工程名称</label>
                        <div class="layui-input-inline">
                            <input type="text" name="name" autocomplete="off" class="layui-input">
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label class="layui-form-label">工程日期</label>
                        <div class="layui-input-inline">
                            <input type="text" name="projectDate" autocomplete="off" class="layui-input">
                        </div>
                    </div>
                </div>

                <div class="layui-form-item">
                    <div class="layui-inline">
                        <label class="layui-form-label">工程总价</label>
                        <div class="layui-input-inline">
                            <input type="text" name="cost" placeholder="￥" lay-verify="number" style="text-align: right" autocomplete="off" class="layui-input">
                        </div>
                    </div>

                    <div class="layui-inline">
                        <label class="layui-form-label">已收款</label>
                        <div class="layui-input-inline">
                            <input type="text" name="costPaid" placeholder="￥" lay-verify="number" style="text-align: right" autocomplete="off" class="layui-input">
                        </div>
                    </div>

                </div>

                <div class="layui-form-item">
                    <div class="layui-inline">
                        <label class="layui-form-label">加工费</label>
                        <div class="layui-input-inline">
                            <input type="text" name="processCost" placeholder="￥" lay-verify="number" style="text-align: right" autocomplete="off" class="layui-input">
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label class="layui-form-label">材料费</label>
                        <div class="layui-input-inline">
                            <input type="text" name="materialCost" placeholder="￥" lay-verify="number" style="text-align: right" autocomplete="off" class="layui-input">
                        </div>
                    </div>
                </div>

                <div class="layui-form-item">
                    <div class="layui-inline">
                        <label class="layui-form-label">开工日期</label>
                        <div class="layui-input-inline">
                            <input type="text" name="beginDate" autocomplete="off" class="layui-input">
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label class="layui-form-label">开工日期</label>
                        <div class="layui-input-inline">
                            <input type="text" name="finishDate" autocomplete="off" class="layui-input">
                        </div>
                    </div>
                </div>

                <div class="layui-form-item">
                    <div class="layui-inline">
                        <label class="layui-form-label">单号</label>
                        <div class="layui-input-inline">
                            <input type="text" name="serialNo" autocomplete="off" class="layui-input">
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label class="layui-form-label">客户</label>
                        <div class="layui-input-inline">
                            <input type="text" name="clientName" autocomplete="off" class="layui-input">
                        </div>
                    </div>
                </div>

                <div class="layui-form-item">
                    <div class="layui-inline">
                        <label class="layui-form-label">客户电话</label>
                        <div class="layui-input-inline">
                            <input type="text" name="clientPhone" autocomplete="off" class="layui-input">
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label class="layui-form-label">客户地址</label>
                        <div class="layui-input-inline">
                            <input type="text" name="clientAddress" autocomplete="off" class="layui-input">
                        </div>
                    </div>
                </div>

                <div class="layui-form-item layui-form-text">
                    <label class="layui-form-label" >备注</label>
                    <div class="layui-input-block">
                        <textarea lay-verify="required" name="note" placeholder="请输入内容" class="layui-textarea"></textarea>
                    </div>
                </div>

            </form>

        </div>

        <div class="layui-tab-item">
            <table id="detailTable" lay-filter="detailTable"></table>
        </div>

        <div class="layui-tab-item">
            <table id="feeTable" lay-filter="feeTable"></table>
        </div>

    </div>
</div>


<!-- -->

<div class="layui-tab layui-tab-card">
    <ul class="layui-tab-title">
        <li class="layui-this">数据查询</li>
        <li>报表统计</li>

    </ul>
    <div class="layui-tab-content">
        <div class="layui-tab-item layui-show">

            <form class="layui-form" action="" lay-filter="example">

                <div class="layui-form-item">

                    <label class="layui-form-label">单号：</label>
                    <div class="layui-input-inline">
                        <input class="layui-input" name="search-serialNo" id="serialNo" autocomplete="off">
                    </div>

                    <label class="layui-form-label">收款情况：</label>
                    <div class="layui-input-inline">
                        <select name="isOK" id="isOK">
                            <option value="">=请选择=</option>
                            <option value="yes">已收齐</option>
                            <option value="no">未收齐</option>
                        </select>
                    </div>

                    <div class="layui-input-inline">
                        <input type="checkbox" name="isValidate" id="isValidate" value="N" title="录入不完整的数据">
                    </div>

                </div>

                <div class="layui-form-item">

                    <label class="layui-form-label">范围：</label>
                    <div class="layui-input-inline">
                        <select name="dateType" id="dateType">
                            <option value="projectDate" selected>工程日期</option>
                            <option value="payDate">支付日期</option>
                        </select>

                    </div>

                    <label class="layui-form-label">从</label>
                    <div class="layui-input-inline">
                        <input class="layui-input" name="beginDate" id="beginDate"  autocomplete="off">
                    </div>

                    <label class="layui-form-label">到</label>
                    <div class="layui-input-inline">
                        <input class="layui-input" name="endDate" id="endDate" autocomplete="off">
                    </div>

                </div>

                <div class="layui-form-item">
                    <label class="layui-form-label"> </label>
                    <div class="layui-input-block">
                        <button type="button" class="layui-btn search" lay-event="search" id="searchBtn"><i class="layui-icon layui-icon-search"></i>查询</button>
                        <button type="button" class="layui-btn layui-btn-normal" lay-event="add" id="addBtn"><i class="layui-icon layui-icon-add-circle"></i>新增</button>
                        <button type="button" class="layui-btn layui-btn-danger" lay-event="del" id="delBtn"><i class="layui-icon layui-icon-delete"></i>删除</button>
                        <button type="button" class="layui-btn layui-btn-normal" lay-event="exp" id="expBtn"><i class="layui-icon layui-icon-export"></i>导出</button>
                    </div>
                </div>

            </form>

            <table id="demoTable" lay-filter="demoTable"></table>

        </div>

        <div class="layui-tab-item">2</div>

    </div>
</div>

<script>

    // var $ = layui.jquery;

    layui.use('laydate', function() {
        var laydate = layui.laydate;

        //常规用法
        laydate.render({
            elem: '#beginDate'
        });

        laydate.render({
            elem: '#endDate'
        });

        //

        laydate.render({
            elem: "#project-form input[name='projectDate']"
        });

        laydate.render({
            elem: "#project-form input[name='beginDate']"
        });

        laydate.render({
            elem: "#project-form input[name='finishDate']"
        });

    });

    layui.use(['jquery', 'table', 'laypage', 'laydate'], function(){

        var table = layui.table;
        var $ = layui.jquery;

        table.render({
         //其它参数在此省略
           // skin: 'row' //行边框风格
            elem: '#demoTable'
            ,url:'/projects'
            //,cellMinWidth: 80 //全局定义常规单元格的最小宽度，layui 2.2.1 新增
            ,cols: [[
                {type: 'checkbox', fixed: 'left'},
                {field:'name', width: 200, title: '工程名称', templet:
                        '<div><a href="javascript:void(0)" onclick="editProject({{d.id}})" class="layui-table-link">{{d.name}}</a></div>'},
                {field:'serialNo',  title: '单号'/*, templet:function(d){ return d==''?'未开单':d}*/},
                {field:'projectDate',  title: '工程日期'},
                {field:'cost',  title: '工程总价', align:'right'},
                {
                    field: 'costPaid', title: '收款情况', align:'right', templet: function (project) {
                        if (project.cost == project.costPaid) {
                            return "<span style='color: green'>OK</span>"
                        } else {
                            return project.costPaid == null ? '未收款' : project.costPaid;
                        }
                    }
                }
               ,{field:'clientName', title: '客户', sort: false}
               ,{field:'clientPhone',  title: '电话', sort: false}
               ,{field:'clientAddress', title: '地址', sort: false}
            ]],
            request: {
                pageName: 'page' //页码的参数名称，默认：page
                ,limitName: 'pageSize' //每页数据量的参数名，默认：limit
            },
            response: {
                statusName: 'code' //规定数据状态的字段名称，默认：code
                ,statusCode: 200 //规定成功的状态码，默认：0
                ,msgName: 'message' //规定状态信息的字段名称，默认：msg
                ,countName: 'data.total' //规定数据总数的字段名称，默认：count
                ,dataName: 'data.records' //规定数据列表的字段名称，默认：data
            },
            page: true,
            limit : 10,
            limits: [10, 25, 50, 100],
            id: 'demoTable'
        });


        $("button#searchBtn").click(function (ev) {
            console.info("searchBtn clicked.");
            table.reload('demoTable', {
                where: {
                    // page: 1,
                    serialNo: $("#serialNo").val(),
                    isDealDone: $("#isOK").val(),
                    isValidate: $('#isValidate').is(':checked') ? "N" : "Y",
                    dateType: $("#dateType").val(),
                    projectFromDate: $("#dateType").val() == "projectDate" ? $("#beginDate").val() : "",
                    projectToDate: $("#dateType").val() == "projectDate" ? $("#endDate").val() : "",
                    payFromDate: $("#dateType").val() == "payDate" ? $("#beginDate").val() : "",
                    payToDate: $("#dateType").val() == "payDate" ? $("#endDate").val() : ""
                } //设定异步数据接口的额外参数

            });

        });

        //监听行单击事件（双击事件为：rowDouble）
        table.on('row(demoTable)', function(obj){
            // var data = obj.data;
            //标注选中样式
            obj.tr.addClass('layui-table-click').siblings().removeClass('layui-table-click');
        });

    });

    function editProject(pid) {
        // layer.alert(JSON.stringify(pid), {
        //     title: '修改记录：'
        // });

        layui.jquery.ajax({url:"/project/"+pid,
            success:function(response){

                layer.open({
                    area: '700px',
                    type: 1,
                    title: '修改记录：',
                    content: layui.jquery("#project-form"),
                    btn: ['保存', '取消'],
                    btnAlign: 'c',
                    yes: function(index, layero){
                        //按钮【按钮一】的回调
                    },
                    保存: function(index, layero){
                        //按钮【按钮二】的回调

                        //return false 开启该代码可禁止点击该按钮关闭
                    },
                    取消: function(index, layero){
                        //按钮【按钮三】的回调

                        //return false 开启该代码可禁止点击该按钮关闭
                    }
                    ,cancel: function(){
                        //右上角关闭回调
                        //return false 开启该代码可禁止点击该按钮关闭
                    },
                    success : function () {
                        //数据绑定

                        layui.jquery("#project-form input[name='name']").val(response.data.name);
                        layui.jquery("#project-form input[name='projectDate']").val(response.data.projectDate);
                        layui.jquery("#project-form input[name='cost']").val(response.data.cost);
                        layui.jquery("#project-form input[name='costPaid']").val(response.data.costPaid);
                        layui.jquery("#project-form input[name='processCost']").val(response.data.processCost);
                        layui.jquery("#project-form input[name='materialCost']").val(response.data.materialCost);
                        layui.jquery("#project-form input[name='beginDate']").val(response.data.beginDate);
                        layui.jquery("#project-form input[name='finishDate']").val(response.data.finishDate);
                        layui.jquery("#project-form input[name='serialNo']").val(response.data.serialNo);
                        layui.jquery("#project-form input[name='clientName']").val(response.data.clientName);

                        layui.jquery("#project-form input[name='clientPhone']").val(response.data.clientPhone);
                        layui.jquery("#project-form input[name='clientAddress']").val(response.data.clientAddress);

                        layui.jquery("#project-form input[name='note']").val(response.data.note);

                        //项目明细
                        layui.table.render({
                            elem: '#detailTable'
                            , cols: [[ //标题栏
                                {field: 'id', title: 'ID', sort: true}
                                , {field: 'material', title: '材料'}
                                , {field: 'length', title: '长' }
                                , {field: 'width', title: '宽'}
                                , {field: 'quantity', title: '数量'}
                                , {field: 'price', title: '单价'}
                                , {field: 'note', title: '备注'}
                            ]]
                            , data: response.data.details
                        });

                        //收费明细
                        layui.table.render({
                            elem: '#feeTable'
                            , cols: [[ //标题栏
                                {field: 'id', title: 'ID', sort: true}
                                , {field: 'payNo', title: '收款单号'}
                                , {field: 'length', title: '支付金额' }
                                , {field: 'width', title: '支付日期'}
                                , {field: 'quantity', title: '用途(定金或付款)'}
                                , {field: 'price', title: '收款人'}
                            ]]
                            , data: response.data.pays
                        });
                        //数据绑定结束
                    }

                });

            }});
    }

</script>


</body>
</html>